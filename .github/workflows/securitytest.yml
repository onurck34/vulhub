name: Secret Scanning (gitleaks, trufflehog, detect-secrets)

on:
  # push:
  #   branches: ["main", "master"]
  # pull_request:
  #   branches: ["main", "master"]
  # schedule:
  #   - cron: "0 2 * * 1" # Her Pazartesi 05:00 TR (UTC+3) yerine uygun cron ayarla
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  secret-scan:
    name: Secret scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks (GitHub Action)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: --path=. --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run TruffleHog (OSS) - GitHub Action
        # trufflehog'un marketplace action'ını kullanıyoruz
        uses: trufflesecurity/trufflehog@v3
        with:
          path: '.'            # taranacak path
          timeout: '20m'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install python and detect-secrets
        run: |
          python -m pip install --upgrade pip
          pip install detect-secrets

      - name: Run detect-secrets scan (generate baseline)
        # Not: production'da baseline'ı manuel oluşturup commit et; burada sadece tarama örneği
        run: |
          detect-secrets scan --all-files > .secrets.baseline || true
          detect-secrets audit .secrets.baseline || true
        # artifacts for review
      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-results
          path: |
            .secrets.baseline
            gitleaks-report.json
            trufflehog-report.json
