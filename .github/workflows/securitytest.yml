name: Secret Scanning (gitleaks, trufflehog, detect-secrets)

on:
  # push:
  #   branches: ["main", "master"]
  # pull_request:
  #   branches: ["main", "master"]
  # schedule:
  #   - cron: "0 2 * * 1" # Her Pazartesi 05:00 TR (UTC+3) yerine uygun cron ayarla
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  secret-scan:
    name: Secret scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks (GitHub Action)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # (İsteğe bağlı) kendi kural setin varsa:
          # GITLEAKS_CONFIG: .github/gitleaks.toml
          # (İsteğe bağlı) belirli sürüme pinlemek istersen:
          # GITLEAKS_VERSION: "8.18.4"   # veya "latest"
          GITLEAKS_ENABLE_SUMMARY: "true"
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: "true"
        continue-on-error: true

      - name: Run TruffleHog (Docker, only verified, don’t fail)
        run: |
          docker run --rm -v "$PWD:/pwd" trufflesecurity/trufflehog:3.90.12 \
            filesystem --directory /pwd --only-verified --json > trufflehog-report.json || true
      - name: Upload TruffleHog report
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-report
          path: trufflehog-report.json

      - name: Run detect-secrets scan (generate baseline)
        # Not: production'da baseline'ı manuel oluşturup commit et; burada sadece tarama örneği
        run: |
          detect-secrets scan --all-files > .secrets.baseline || true
          detect-secrets audit .secrets.baseline || true
        # artifacts for review
      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-results
          path: |
            .secrets.baseline
            gitleaks-report.json
            trufflehog-report.json
